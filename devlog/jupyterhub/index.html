<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.2.0">
  <meta name="generator" content="Hugo 0.52" />
  <meta name="author" content="Michael Pilosov">

  
  
  
  
    
  
  <meta name="description" content="Yet More JupyterHub">

  
  <link rel="alternate" hreflang="en-us" href="https://www.michaelpilosov.com/devlog/jupyterhub/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="hsl(339, 90%, 68%)">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  

  <link rel="stylesheet" href="/styles.css">
  
  <link rel="stylesheet" href="/css/custom_css.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-122657370-3', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="https://www.michaelpilosov.com/index.xml" type="application/rss+xml" title="Michael Pilosov | Academic Website">
  <link rel="feed" href="https://www.michaelpilosov.com/index.xml" type="application/rss+xml" title="Michael Pilosov | Academic Website">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.michaelpilosov.com/devlog/jupyterhub/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@Mathematical_MP">
  <meta property="twitter:creator" content="@Mathematical_MP">
  
  <meta property="og:site_name" content="Michael Pilosov | Academic Website">
  <meta property="og:url" content="https://www.michaelpilosov.com/devlog/jupyterhub/">
  <meta property="og:title" content="Jupyterhub | Michael Pilosov | Academic Website">
  <meta property="og:description" content="Yet More JupyterHub"><meta property="og:image" content="https://www.michaelpilosov.com/img/logo-dark.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2018-12-25T00:00:00-07:00">
  
  <meta property="article:modified_time" content="2019-01-01T14:43:00-07:00">
  

  

  

  <title>Jupyterhub | Michael Pilosov | Academic Website</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" class="dark">
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" role="textbox" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/"><img src="/img/logo-dark.png" alt="Michael Pilosov | Academic Website"></a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#about">
            
            <span>About</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/openscience">
            
            <span>Open Science</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#resume">
            
            <span>Resume</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        

      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>



<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
  <input name="q" type="search" class="form-control" id="search-query" placeholder="Search..." autocomplete="off">
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/devlog/academicupgrades/">Website</a>
    <ul class="nav docs-sidenav">
      
      <li >
        <a href="/devlog/academicupgrades/">Upgrading</a>
      </li>
      
    </ul>
    

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/devlog/">devlog</a>
    <ul class="nav docs-sidenav">
      
      <li >
        <a href="/devlog/docker/">Day 5</a>
      </li>
      
      <li class="active">
        <a href="/devlog/jupyterhub/">Jupyterhub</a>
      </li>
      
      <li >
        <a href="/devlog/openscience/">Open Science</a>
      </li>
      
      <li >
        <a href="/devlog/widgets/">Widgets</a>
      </li>
      
    </ul>
    

  </div>
  
  
</nav>

    </div>

    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      
      <p class="docs-toc-title">On this page</p>
      

      <nav id="TableOfContents">
<ul>
<li><a href="#status-report">Status Report</a></li>
<li><a href="#new-server">New Server</a></li>
<li><a href="#next-day">Next Day</a></li>
<li><a href="#volumes-working">VOLUMES WORKING!</a></li>
</ul>
</nav>

      <ul class="nav toc-top">
        <li><a href="#">Back to top</a></li>
      </ul>

      
    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article" itemscope itemtype="http://schema.org/Article">

        <div class="docs-article-container">
          <h1 itemprop="name">Jupyterhub</h1>

          <div class="article-style" itemprop="articleBody">
            

<h1 id="status-report">Status Report</h1>

<p>Okay so where are we at?</p>

<ul>
<li><code>Spawner</code> needs to be sussed out. Right now I really like DockerSpawner, and it seems to persist storage.

<ul>
<li>Each student gets a user account but it&rsquo;s only used for authenetication right now. Can&rsquo;t figure out volume-mapping.</li>
</ul></li>

<li><p>With <code>dockerspawner.DockerSpawner</code>:</p>

<ul>
<li>Each time someone is logged in, a container is either loaded up or built from <code>jupyterlab_img</code> container. These are very flexible, many stacks available.</li>
<li>In this set-up, each student gets a container, which is a full-fledged linux machine. Since Docker is managing these alongside Dockerhub in the network, communication between containers is not possible right now. <em>should be</em></li>
<li>One hour of inactivity results in shutdown of container thanks to a python script from jupyter.</li>
</ul></li>

<li><p>What we want: <code>dockerspawner.SystemUserSpawner</code></p>

<ul>
<li>with maps to home directories that exist on the <code>jupyterhub</code> container.</li>
<li>this way a teacher opens the docker container with the &ldquo;hub&rdquo; and all the students are there.</li>
</ul></li>

<li><p>What we have now:</p>

<ul>
<li>each student has a container with their name on it. each is its own linux machine</li>
<li>to get into their linux machines, run <code>docker exec -ti jupyter-{surname} /bin/bash</code>, do your thing, <code>Ctrl-D</code> to exit.</li>
<li>The script that gets installed in the hub container stops idle single-user servers (<em>I think this means it shuts down the containers that are inactive</em>).</li>
<li>The containers are spun up based on a jupyterlab image.

<ul>
<li><em>What happens when we update this? Perhaps to include files for every student?</em></li>
</ul></li>
<li><strong>Alternatively, you have all of them learn to manage push/pull from a class repository</strong></li>
<li>It appears that to do this, we <a href="https://github.com/jupyterhub/dockerspawner/issues/172" target="_blank">sub-class the Spawner</a>.</li>
</ul></li>
</ul>

<pre><code class="language-python">    from dockerspawner import DockerSpawner
    class MyDockerSpawner(DockerSpawner):
        team_map = {
            'user1': 'team1',
            'user2': 'team1',
            'user3': 'team2',
        }

        def start(self):
            team = self.team_map[self.user.name]
            # add team volume to volumes
            self.volumes['jupyterhub-team-{}'.format(team)] = {
                'bind': '/home/shared/{}'.format(team),
                'mode': 'rw',  # or ro for read-only
            }

    c.JupyterHub.spawner_class = MyDockerSpawner
</code></pre>

<hr />

<h1 id="new-server">New Server</h1>

<p>As root:</p>

<pre><code>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
sudo apt-get update
apt-cache policy docker-ce
sudo apt-get install -y docker-ce

sudo groupadd docker
sudo usermod -aG docker $USER
# also add any users you want to be running docker. 
# I added `michael` on my machine. will have to log out/in to refresh group membership. 

sudo apt-get install -y docker-compose
</code></pre>

<p>As user <code>michael</code>:</p>

<pre><code>cd repos/
git clone git clone https://github.com/mathematicalmichael/hubsetup.git
cd hubsetup/

# make sure you clean up images/volumes/containers. I didn't have much there from before, did have hello-world.

docker-compose build
</code></pre>

<p>This came up, may be a problem?</p>

<pre><code>WARNING: The COMPOSE_PROJECT_NAME variable is not set. Defaulting to a blank string.
</code></pre>

<p>But it kept going&hellip;</p>

<p>but then.</p>

<pre><code>ERROR: Service 'jupyterlab' failed to build: failed to register layer: Error processing tar file(exit status 1): write /opt/conda/lib/python3.6/site-packages/pandas/_libs/tslibs/timestamps.cpython-36m-x86_64-linux-gnu.so: no space left on device
</code></pre>

<p>So I went ahead and deleted a couple GB of space by removing unused conda environments and Lucas&rsquo; user account.</p>

<pre><code>docker-compose u
</code></pre>

<p>fairly sure this will fail because of a mis-specified IP address.
Should also enable security since now I have them on this server.</p>

<p>the SSL is messing with me since I already have it set up on the server.</p>

<p>trying to launch jupyterhub with dockerspawner with jupyterhub local install.</p>

<p><code>export DOCKER_JUPYTER_IMAGE=jupyter/datascience-notebook:7254cdcfa22b</code></p>

<p>Okay well the hub worked and spawner did not.</p>

<p>I dove into making a custom spawner (may be necessary?), but it was a rabbit hole.</p>

<hr />

<h1 id="next-day">Next Day</h1>

<p>Messed around with apache but couldn&rsquo;t make it work.
<a href="https://jupyterhub.readthedocs.io/en/latest/reference/config-proxy.html" target="_blank">Documentation on Jupyter&rsquo;s website is god awful</a>, there are numerous omissions and a typo in the configuration files (including ones from the <a href="https://github.com/jupyterhub/oauthenticator/tree/master/examples/full" target="_blank">repository</a> I got my original setup files), no context or setup instructions. They just assume you know what you are doing.</p>

<p>I do not, though. So let&rsquo;s go through it.</p>

<p>Here&rsquo;s what a reverse-proxy is doing.
It catches requests to a website and handles them.</p>

<p>When you hit <a href="consistentbayes.com" target="_blank">consistentbayes.com</a>, it directs you to a folder with a bunch of files that make up my website. I had that working with Apache but couldn&rsquo;t do what I wanted, which was direct traffic to &ldquo;hub.consistentbayes.com&rdquo; instead.</p>

<p>I got the &ldquo;hub&rdquo; part set up by adding an <code>A Record</code> into my DNS Control Panel (talk more about that later). Now the proxy just had to be able to handle and direct that request to a jupyterhub instance running in a docker container that was exposing itself on <code>http://127.0.0.1:8000</code> (I&rsquo;ll show config files later). The hub would be in a container that is just a Linux machine, with users and everything in there.</p>

<p>If the container name is &ldquo;nostalgic_colden&rdquo; (TO DO: figure out how to name these)&hellip; then running</p>

<pre><code>docker exec -ti -u mpilosov nostalgic_colden /bin/bash
</code></pre>

<p>will log you into the linux computer as &ldquo;mpilosov&rdquo;</p>

<p>The user accounts are handled at build-time, but can be managed within the computer just as you would on a linux machine (to log in as <code>root</code>, omit <code>-u mpilosov</code> above).</p>

<p>So&hellip; those accounts.
Github usernames. By far the best authentication method I found, but it relied on having a Fully Qualified Domain Name (website name, which the server at school would not let me do).
But&hellip; we can loop the authenticator to whatever we want.</p>

<p>Here are my nginx configurations:</p>

<p>In <code>/etc/nginx/sites-enabled/consistentbayes.conf</code></p>

<pre><code>server {
    listen 80;
    server_name NO_HUB.DOMAIN.TLD;

    # Tell all requests to port 80 to be 302 redirected to HTTPS
    return 302 https://$host$request_uri;
}

server {
    listen 443;
    ssl on;

    # INSERT OTHER SSL PARAMETERS HERE AS ABOVE
    # SSL cert may differ

    # Set the appropriate root directory
    root /var/www/html;

    # Set URI handling
    location / {
        try_files $uri $uri/ =404;
    }

    # Managing requests to verify letsencrypt host
    location ~ /.well-known {
        allow all;
    }

}
</code></pre>

<p>In <code>/etc/nginx/sites-enabled/jupyterhub.conf</code> (titles dont matter it seems).</p>

<pre><code># top-level http config for websocket headers
# If Upgrade is defined, Connection = upgrade
# If Upgrade is empty, Connection = close
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# HTTP server to redirect all 80 traffic to SSL/HTTPS
server {
    listen 80;
    server_name HUB.DOMAIN.TLD;

    # Tell all requests to port 80 to be 302 redirected to HTTPS
    return 302 https://$host$request_uri;
}

# HTTPS server to handle JupyterHub
server {
    listen 443;
    ssl on;

    server_name HUB.DOMAIN.TLD;

    ssl_certificate /etc/letsencrypt/live/HUB.DOMAIN.TLD/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/HUB.DOMAIN.TLD/privkey.pem;

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_stapling on;
    ssl_stapling_verify on;
    add_header Strict-Transport-Security max-age=15768000;

    # Managing literal requests to the JupyterHub front end
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # websocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Managing requests to verify letsencrypt host
    location ~ /.well-known {
        allow all;
    }
}
</code></pre>

<p>Talk about how you had to generate letsencrypt scripts for nginx with <code>certbot</code>.</p>

<pre><code>sudo apt install python-certbot-nginx
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install python-certbot-nginx 
sudo certbot --nginx certonly
</code></pre>

<p>I actually ran into trouble being unable to start nginx with the sites enabled. Kind of a catch-22. Removed letsencrypt files</p>

<pre><code>$ sudo certbot certonly --webroot -w /var/www/example -d example.com -d www.example.com -w /var/www/thing -d thing.is -d m.thing.is
</code></pre>

<p>This command will obtain a single cert for example.com, www.example.com, thing.is, and m.thing.is; it will place files below /var/www/example to prove control of the first two domains, and under /var/www/thing for the second pair.</p>

<p><em>I dont quite want that. Let&rsquo;s try the interactive.;</em>
<code>sudo certbot certonly</code>
Hit 1, enter website names (consistentbayes.com, www.consistentbayes.com),</p>

<p>Then do the same again for the hub.consistentbayes.com</p>

<p>And we&rsquo;re golden. The files have been placed where nginx is expecting them to be. (e.g. <code>/etc/letsencrypt/live/hub.consistentbayes.com/fullchain.pem</code>)</p>

<p>And also you will need to issue the following command once.</p>

<pre><code>openssl dhparam -out /etc/ssl/certs/dhparam.pem 4096
</code></pre>

<p>And then go ahead and make the <code>Dockerfile</code>:</p>

<pre><code># Designed to be run as
#
# docker run -it -p 8000:8000 jupyterhub/oauthenticator

FROM jupyterhub/jupyterhub

MAINTAINER Project Jupyter &lt;ipython-dev@scipy.org&gt;

# Install oauthenticator from git
RUN python3 -m pip install oauthenticator
RUN python3 -m pip install notebook&gt;=4.0
# Create oauthenticator directory and put necessary files in it
RUN mkdir /srv/oauthenticator
WORKDIR /srv/oauthenticator
ENV OAUTHENTICATOR_DIR /srv/oauthenticator
ADD jupyterhub_config.py jupyterhub_config.py
ADD addusers.sh /srv/oauthenticator/addusers.sh
ADD userlist /srv/oauthenticator/userlist
ADD ssl /srv/oauthenticator/ssl
RUN chmod 700 /srv/oauthenticator

RUN [&quot;sh&quot;, &quot;/srv/oauthenticator/addusers.sh&quot;]
</code></pre>

<p>Then this bash script <code>addusers.sh</code>:</p>

<pre><code>#!/bin/sh

IFS=&quot;
&quot;
for line in `cat userlist`; do
  test -z &quot;$line&quot; &amp;&amp; continue
  user=`echo $line | cut -f 1 -d' '`
  echo &quot;adding user $user&quot;
  useradd -m -s /bin/bash $user
#  cp -r /srv/ipython/examples /home/$user/examples
  mkdir /home/$user/examples
# may only be necessary since we are copying files from root above.
  chown -R $user /home/$user/examples
done
</code></pre>

<p>And, for now, the simplest version of our <code>jupyterhub_config.py</code>:</p>

<pre><code># Configuration file for Jupyter Hub

c = get_config()

c.JupyterHub.log_level = 10
from oauthenticator.github import LocalGitHubOAuthenticator
c.JupyterHub.authenticator_class = LocalGitHubOAuthenticator
c.GenericOAuthenticator.login_service = 'my service'

c.LocalGitHubOAuthenticator.create_system_users = True

c.Authenticator.whitelist = whitelist = set()
c.JupyterHub.admin_users = admin = set()

import os
import sys

join = os.path.join

here = os.path.dirname(__file__)
root = os.environ.get('OAUTHENTICATOR_DIR', here)
sys.path.insert(0, root)

with open(join(root, 'userlist')) as f:
    for line in f:
        if not line:
            continue
        parts = line.split()
        name = parts[0]
        whitelist.add(name)
        if len(parts) &gt; 1 and parts[1] == 'admin':
            admin.add(name)

c.GitHubOAuthenticator.oauth_callback_url = os.environ['OAUTH_CALLBACK_URL']
</code></pre>

<p>A <code>userlist</code> file with github usernames<sup class="footnote-ref" id="fnref:admin"><a href="#fn:admin">1</a></sup></p>

<pre><code>mpilosov admin
mathematicalmichael
eescu 
</code></pre>

<p>A <code>ssl</code> folder with encryption keys in them (which we won&rsquo;t use!)
(We don&rsquo;t use them because we expose Jupyterhub in http, and use the reverse-proxy to handle the security).</p>

<p>And an <code>env</code> file</p>

<pre><code># add your github oauth config to this file,
# and run the container with `docker run -it -p 9000:8000 --env-file=env jupyterhub-oauth`
OAUTH_CLIENT_ID=
OAUTH_CLIENT_SECRET=
OAUTH_CALLBACK_URL=https://hub.consistentbayes.com/hub/oauth_callback
</code></pre>

<p>Which you get when you register the application on Github. (I filled in the third to show you, the first two are secrets!)</p>

<p>So from here on, we can start tweaking the spawner, volume persistence, do checks on memory limits, etc. Write up detailed instructions. Jupyterhub from docker like this is nice.</p>

<p>I think we can test directory-mounting right to the linux machine to be honest.</p>

<p>OMG I RAN THIS AND IT WORKED. I mounted volumes to folders on a per-user basis (since users live inside the container that jupyterhub is in). No write permissions, but they can see files just fine. Cant duplicate.</p>

<pre><code>docker run -it -p 8000:8000 -v /home/michael/repos/:/home/mathematicalmichael/examples -v /home/michael/repos:/home/mpilosov/examples --env-file=env --name hubtest jupyterhub-oauth
</code></pre>

<p>Problem with relying on user data in the hub is potential updates could cause loss of files. mounting volumes would fix this for sure. But they can&rsquo;t write files in this new directory, so&hellip;</p>

<p>I think the best storage solution is each student has their own container. <code>hubname-studentname</code> that a teacher can get into. For workshops, the solution presented as-is works great.</p>

<ul>
<li>Make sure to upgrade pip, no one seems to.</li>
<li>volume permissions are probably things joe knows about.</li>
</ul>

<h1 id="volumes-working">VOLUMES WORKING!</h1>

<p><code>--mount</code> creates directories if they dont exist, whereas <code>--volume</code> does not. Good to create up at root one <code>/shared</code> directory. Additionally we can link them to volumes to host their data instead, managed via docker. Ideally we use a mix of the two.
Adding a volume (even if it doesn&rsquo;t exist) to be managed by docker would be accomplished with -v <code>volume-name:/directory/to/mount</code></p>

<p>So we should think about what in our docker-compose we can automatically mount. Additionally (or in replacement), volumes can be handled via the spawner.</p>

<p>In either set up, we can shut down and restart the container all we want and data persists. We can even re-build the image. Volumes seem to just be symbolic links to directories on your unix machine, anyway, visible via <code>docker inspect volume-name</code>.</p>

<pre><code>docker run -d -it -p 8000:8000 --mount source=/home/michael/repos/packages/lyricalart,type=bind,target=/home/mpilosov/examples/shared-folder-mp/,bind-propagation=rshared --mount source=/home/michael/repos/packages/lyricalart,type=bind,target=/home/mathematicalmichael/shared-folder-mm/,bind-propagation=rshared --env-file=env --name hub jupyterhub-oauth
</code></pre>

<p>Now that we&rsquo;ve got this figured out&hellip; It would be nice to figure out how to get that <code>docker-compose</code> up and running, including with the nginx server, all based on a configuration file that takes in the website name, ip of host, etc. so you can get in, git clone, run bash script, edit the ip, and close out knowing it will work.</p>

<p>To build everything, we did <code>docker build -t jupyterhub-oauth .</code> in the directory we set up.</p>

<p>Definitely want to containerize each student. Currently it&rsquo;s possible to get into the directories mounted above as shared by going through Terminal. Can move files in/out&hellip; not good.</p>

<p>To destroy containers after they close down, simply add <code>.remove = True</code> to the <code>c.DockerSpawner</code> attributes.</p>

<p>[8:59 PM] Pilosov, Michael
oficially did it on hub.consistentbayes.com! holy shit that took forever but I linked up the pieces. Now it spawns up containers per user, with BOTH volumes that persist even as containers change and shared directories accessible by all users, automatically mounted to every user.
One environment file controls everything. the version of jupyterhub, the docker image you want to spawn, etc.
​
[9:04 PM] Pilosov, Michael
that is our ideal set up.. the shared folders can be determined by rules such as group membership (students within class or even, and the environment to spawn can be similarly chosen. This means we can use one hub for every student across every class with total ease. No containers stick around. At all. They just get appropriately mounted to volumes when they are created. the decision to make one hub per class is purely an aesthetic one. the hub can spin up dozens of different configurations depending on what the user needs.
I&rsquo;m going to package this all nice so that I can deploy to a powerful server that I can rent for like &hellip;. a couple hours for testing. Throw a whole bunch of simultaneous use-cases at it.
​
[9:08 PM] Pilosov, Michael
we can even use the admin panel to start/stop servers instead of logging in simultaneously. if each single-user server has a heavy python script to run on startup, we can simulate heavy loads. I played around a little already and saw the containers being created (not restarted, created!) when I &ldquo;started&rdquo; the single-user server and then thrown away when I clicked &ldquo;stop&rdquo; which keeps our physical memory literally AT THE LOWEST possible limit at any given time since stopped containers dont have to sit around.</p>

<p>So, how?</p>

<p>I cloned the jupyterhub-deploy-docker repo. (again), and made my fixes&hellip;</p>

<p>I don&rsquo;t know why the Makefile doesn&rsquo;t handle this, but
<code>echo &quot;POSTGRES_PASSWORD=$( openssl rand -hex 32)&quot; &gt;&gt; secrets/postgres.env</code> will create a necessary file for <code>make build</code> to work. And after that works, run <code>make notebook_image</code> to create the necessary image to be spawned based on the  <code>.env</code> file in the root directory.</p>

<p>I commented out lines 40-49 in the <code>Makefile</code> since I want to handle certification on my own through the reverse proxy.</p>

<p>Would be nice to get this working with nginx as well. But all that stuff can be handled from the bash script.</p>

<p>In the <code>jupyterhub_config.py</code> file, I removed references to SSL and set up shared volumes.
It would be great to learn how to sub-class the spawner now and create rules for mounting volumes. A simple restart lets students gain new files.</p>

<p>I also removed SSL references from <code>Dockerfile.jupyerhub</code></p>

<p>[Docker-compose guidelines][docker-compose]</p>

<p>Just tested the containerized solution and love it (even though i built small containers). I can log in, add nbextensions as root, and the changes are reflected <em>without touching docker</em>. No restarting required.</p>

<p>Can add user accounts as admin through the cPanel. If they don&rsquo;t exist, a home directory or volume is created on their behalf.
I wouldn&rsquo;t suggest sharing directories automatically for the containerized solutions. <em>That part</em> should be part of a custom spawner (and require hub restart, which can also be done through cpanel since it runs on another port!).</p>

<p>Admin is powerful! You can start/stop servers at your whim and launch them to poke around on your own. Very cool.</p>

<p>For a smaller class, auto-mounting some shared directory is a great idea.</p>

<hr />

<p>Here is something interesting for version-controlling notebooks.
<a href="https://github.com/mwouts/jupytext" target="_blank">https://github.com/mwouts/jupytext</a></p>

<p>Here is an introduction to the notebook format.
<a href="https://nbformat.readthedocs.io/en/latest/format_description.html" target="_blank">https://nbformat.readthedocs.io/en/latest/format_description.html</a>
You should turn this into a write-up.</p>

<p>The basic examples in here are actually a great demo of publishing LaTeX documents right from Jupyter.
<a href="https://github.com/jupyter/nbconvert-examples" target="_blank">https://github.com/jupyter/nbconvert-examples</a></p>

<hr />

<p>Nice article
<a href="https://blog.dominodatalab.com/data-science-vs-engineering-tension-points/" target="_blank">https://blog.dominodatalab.com/data-science-vs-engineering-tension-points/</a></p>

<p>This might be how to set up binderhub on your own &ndash; minikube
<a href="https://github.com/jupyterhub/binderhub/blob/master/CONTRIBUTING.md" target="_blank">https://github.com/jupyterhub/binderhub/blob/master/CONTRIBUTING.md</a></p>

<p>Other Projects for sharing results:
<a href="https://github.com/minrk/thebelab" target="_blank">https://github.com/minrk/thebelab</a>
<a href="https://github.com/QuantStack/voila" target="_blank">https://github.com/QuantStack/voila</a>
Write about them in a new section summarizing sharing results.</p>

<p><a href="https://github.com/jupyter/dashboards" target="_blank">https://github.com/jupyter/dashboards</a></p>

<p>Adding extra libraries to the jupyter-stacks image
<a href="https://github.com/binder-examples/jupyter-stacks" target="_blank">https://github.com/binder-examples/jupyter-stacks</a></p>

<p>Allowing students to get latest files without knowing git
<a href="https://github.com/jupyterhub/nbgitpuller" target="_blank">https://github.com/jupyterhub/nbgitpuller</a></p>

<blockquote>
<p>When a link is clicked, we try to make opinionated intelligent guesses on how to do a merge automatically, without making the user do a conflict resolution. nbgitpuller is designed to be used by folks who do not know that git is being used underneath, and are only pulling content one way from a source and modifying it - not pushing it back. So we have made the following opinionated decisions.</p>

<ul>
<li>If content has changed in both places, prefer local changes over remote changes.</li>
<li>If a file was deleted locally but present in the remote, remote file is restored to local repository. This allows users to get a &lsquo;fresh copy&rsquo; of a file by just deleting the file locally &amp; clicking the link again.</li>
<li>If a file exists locally but is untracked by git (maybe someone uploaded it manually), then rename the file, and pull in remote copy.</li>
</ul>
</blockquote>

<p>Hippylib-Hub, example to follow.
<a href="https://github.com/g2s3-2018/hippylib-hub" target="_blank">https://github.com/g2s3-2018/hippylib-hub</a></p>

<p>Want:
    - Dockerspawner is nice (can restart hub without issues).
    - Although, restarting if all-in-one isn&rsquo;t that bad, either. Temporary inconvenience.</p>

<p>Add this to installations!!! It&rsquo;s amazing.
<a href="https://github.com/yuvipanda/nbresuse" target="_blank">https://github.com/yuvipanda/nbresuse</a></p>

<p>This might be a good thing to test on our server.
<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/</a></p>

<p>USEFUL: in Vim:
<code>r:! openssl rand -hex 32</code> will paste a token into a file like <code>config.yaml</code></p>

<pre><code>proxy:
    secretToken: xxxx
</code></pre>

<p>To-Do today:</p>

<ul>
<li>Documentation on Projects.</li>
<li>Galleries</li>
<li>Art for 2019?</li>
<li>Documentation for Jupyterhub, convert devlogs.</li>
<li>Build shell script for deployments, fenics?</li>
</ul>

<p>Wow I can&rsquo;t believe this exists.
<a href="https://www.katacoda.com/" target="_blank">https://www.katacoda.com/</a></p>

<p>This is a good file-storage solution
<a href="https://www.youtube.com/watch?v=hqE5c5pyfrk" target="_blank">https://www.youtube.com/watch?v=hqE5c5pyfrk</a>
<a href="https://storageos.com/developers/" target="_blank">https://storageos.com/developers/</a>
another alternative, which appears to be a bit more complicated to set-up (though helm-chart should be available by now), but is open-source and from redhat: <a href="https://www.youtube.com/watch?v=Fgpr2lMnBVY" target="_blank">https://www.youtube.com/watch?v=Fgpr2lMnBVY</a> [16:30]</p>

<p>Kubernetes 101 introduction
<a href="https://medium.com/google-cloud/kubernetes-101-pods-nodes-containers-and-clusters-c1509e409e16" target="_blank">https://medium.com/google-cloud/kubernetes-101-pods-nodes-containers-and-clusters-c1509e409e16</a></p>

<p>The monitoring of my memory usage led me to discover that repeated execution of plotting cells led to memory usage going through the roof. The solution was to add this cell-magic to the top of any plotting-cell: <code>%reset -f out</code>. What this does is purge the output of the cell</p>

<hr />

<p>To get a bash script for the set-up, you need to package the reverse-proxy with docker-compose. Let&rsquo;s figure out how to use Traefik. Between these two sources, you should be able to figure it out:
<a href="https://github.com/defeo/jupyterhub-docker/blob/master/docker-compose.yml" target="_blank">https://github.com/defeo/jupyterhub-docker/blob/master/docker-compose.yml</a>
<a href="https://github.com/containous/traefik/blob/master/examples/quickstart/docker-compose.yml" target="_blank">https://github.com/containous/traefik/blob/master/examples/quickstart/docker-compose.yml</a></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:admin">Fun note, it may be possible to accidentally revoke admin privileges from everyone. <em>Test this</em>. But editing the config file in the container as root should be able to make it work again.
 <a class="footnote-return" href="#fnref:admin"><sup>^</sup></a></li>
</ol>
</div>

          </div>

          


<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/dev/">dev</a>
  
  <a class="badge badge-light" href="/tags/jupyter/">jupyter</a>
  
  <a class="badge badge-light" href="/tags/openscience/">openscience</a>
  
  <a class="badge badge-light" href="/tags/docker/">docker</a>
  
</div>



        </div>

        <div class="body-footer">
          Last updated on Jan 1, 2019
        </div>

      </article>

      <footer class="site-footer">
  
  <p class="powered-by">
    <a href="/privacy/">Privacy Policy</a>
  </p>
  

  <p class="powered-by">
    &copy; 2018 Michael Pilosov &middot; 

    
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic</a> +
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>

    
  </p>
</footer>


    </main>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    <script src="/js/academic.min.d037ee5294b166a79dec317c58aea9cc.js"></script>

    

  </body>
</html>


